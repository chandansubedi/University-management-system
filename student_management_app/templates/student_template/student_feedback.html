{% extends 'student_template/base_template.html' %}

{% block page_title %}
    Messages & Feedback
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-comments mr-2"></i>Messages & Feedback
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="row no-gutters">
                            <!-- Chat Area -->
                            <div class="col-md-12">
                                <div id="chat-area" style="height: 600px; display: flex; flex-direction: column;">
                                    <!-- Chat Header -->
                                    <div class="chat-header p-3 border-bottom bg-light">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-warning text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user-shield"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Admin</h6>
                                                <small class="text-muted">Send messages and feedback</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Messages Area -->
                                    <div class="messages-container flex-grow-1 p-3" id="messages-container" style="overflow-y: auto; background-color: #f8f9fa;">
                                        {% if messages %}
                                            {% for message in messages %}
                                                {% if message.message_type == 'student_to_admin' %}
                                                    <!-- Student Message (Sent) -->
                                                    <div class="d-flex justify-content-end mb-3">
                                                        <div class="message-bubble message-sent">
                                                            <div class="message-text">{{ message.content }}</div>
                                                            <div class="message-time text-left" data-time="{{ message.created_at|date:'c' }}">{{ message.created_at|date:"M d, Y H:i" }}</div>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <!-- Admin Message (Received) -->
                                                    <div class="d-flex justify-content-start mb-3">
                                                        <div class="message-bubble message-received">
                                                            <div class="message-text">{{ message.content }}</div>
                                                            <div class="message-time text-right" data-time="{{ message.created_at|date:'c' }}">{{ message.created_at|date:"M d, Y H:i" }}</div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-center py-5">
                                                <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">No Messages Yet</h5>
                                                <p class="text-muted">Type your message below to start the conversation.</p>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Message Input Area -->
                                    <div class="message-input-area p-3 border-top bg-white">
                                        <form method="post" action="{% url 'student_feedback_save' %}">
                                            {% csrf_token %}
                                            <div class="input-group">
                                                <textarea name="feedback_message" class="form-control" rows="2" placeholder="Type your message here..." required></textarea>
                                                <div class="input-group-append">
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-paper-plane"></i> Send
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
}

.message-sent {
    background-color: #28a745;
    color: white;
    border-bottom-right-radius: 4px;
}

.message-received {
    background-color: #e9ecef;
    color: #333;
    border-bottom-left-radius: 4px;
}

.message-text {
    margin-bottom: 4px;
    line-height: 1.4;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
}

.messages-container {
    scroll-behavior: smooth;
}

/* Auto-scroll to bottom */
.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Form styling */
.message-input-area textarea {
    resize: none;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 12px 16px;
}

.message-input-area textarea:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.message-input-area .btn {
    border-radius: 20px;
    padding: 8px 20px;
    margin-left: 8px;
}

/* Chat header styling */
.chat-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.chat-header .avatar-sm {
    background-color: rgba(255, 255, 255, 0.2) !important;
}

/* Responsive design */
@media (max-width: 768px) {
    .message-bubble {
        max-width: 85%;
    }
    
    .message-input-area textarea {
        font-size: 16px; /* Prevents zoom on iOS */
    }
}
</style>

<script>
$(document).ready(function(){
    // Auto-scroll to bottom of messages
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Auto-resize textarea
    $('textarea[name="feedback_message"]').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Focus on textarea when page loads
    $('textarea[name="feedback_message"]').focus();
    
    // Function to update time display
    function updateTimeDisplay() {
        $('.message-time[data-time]').each(function() {
            const timeElement = $(this);
            const timeString = timeElement.data('time');
            const messageTime = new Date(timeString);
            const now = new Date();
            const diffMs = now - messageTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            let displayTime;
            if (diffMins < 1) {
                displayTime = 'Just now';
            } else if (diffMins < 60) {
                displayTime = diffMins + 'm ago';
            } else if (diffHours < 24) {
                displayTime = diffHours + 'h ago';
            } else if (diffDays < 7) {
                displayTime = diffDays + 'd ago';
            } else {
                displayTime = messageTime.toLocaleDateString() + ' ' + messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            timeElement.text(displayTime);
        });
    }
    
    // Update time display every minute
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 60000);
});
</script>

{% endblock main_content %}