{% extends 'hod_template/base_template.html' %}

{% block page_title %}
    Student Messages
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-comments mr-2"></i>Student Messages
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-success">{{ student_conversations|length }} Conversations</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row no-gutters">
                            <!-- Conversations List -->
                            <div class="col-md-4 border-right">
                                <!-- Search Bar -->
                                <div class="p-3 border-bottom">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="search-student" placeholder="Search students...">
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="conversations-list" style="height: 600px; overflow-y: auto;">
                                    {% for student, messages in student_conversations.items %}
                                    <div class="conversation-item p-3 border-bottom conversation-card" data-student-id="{{ student.id }}" style="cursor: pointer;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 text-success">
                                                    {{ student.first_name }} {{ student.last_name }}
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    {% with latest_message=messages|last %}
                                                        {% if latest_message.message_type == 'admin_to_student' %}
                                                            <i class="fas fa-reply text-success mr-1"></i>{{ latest_message.content|truncatechars:30 }}
                                                        {% else %}
                                                            <i class="fas fa-comment text-success mr-1"></i>{{ latest_message.content|truncatechars:30 }}
                                                        {% endif %}
                                                    {% endwith %}
                                                </p>
                                                <small class="text-muted">
                                                    {% with latest_message=messages|last %}
                                                        {{ latest_message.created_at|date:"M d, Y H:i" }} NPT
                                                    {% endwith %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No Messages</h5>
                                        <p class="text-muted">No students have sent messages yet.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Chat Area -->
                            <div class="col-md-8">
                                <div id="chat-area" style="height: 600px; display: flex; flex-direction: column;">
                                    <!-- Chat Header -->
                                    <div class="chat-header p-3 border-bottom bg-light" id="chat-header" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0" id="chat-student-name"></h6>
                                                <small class="text-muted" id="chat-student-info"></small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Messages Area -->
                                    <div class="messages-container flex-grow-1 p-3" id="messages-container" style="overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="text-center py-5" id="no-message-selected">
                                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">Select a Conversation</h5>
                                            <p class="text-muted">Choose a student from the list to view and reply to messages.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Reply Area -->
                                    <div class="reply-area p-3 border-top bg-white" id="reply-area" style="display: none;">
                                        <form id="reply-form">
                                            {% csrf_token %}
                                            <input type="hidden" id="reply_student_id" name="id">
                                            <div class="input-group">
                                                <textarea name="reply" class="form-control" rows="2" placeholder="Type your reply here..." required></textarea>
                                                <div class="input-group-append">
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-paper-plane"></i> Send
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.active {
    background-color: #e8f5e8;
    border-left: 4px solid #28a745;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
    margin-bottom: 8px;
}

.message-sent {
    background-color: #28a745;
    color: white;
    border-bottom-right-radius: 4px;
    margin-left: auto;
}

.message-received {
    background-color: #e9ecef;
    color: #333;
    border-bottom-left-radius: 4px;
    margin-right: auto;
}

.message-text {
    margin-bottom: 4px;
    line-height: 1.4;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
}

.messages-container {
    scroll-behavior: smooth;
}

.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.reply-area textarea {
    resize: none;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 12px 16px;
}

.reply-area textarea:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.reply-area .btn {
    border-radius: 20px;
    padding: 8px 20px;
    margin-left: 8px;
}

.chat-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.chat-header .avatar-sm {
    background-color: rgba(255, 255, 255, 0.2) !important;
}

@media (max-width: 768px) {
    .message-bubble {
        max-width: 85%;
    }
    
    .reply-area textarea {
        font-size: 16px;
    }
}
</style>

{% endblock main_content %}

{% block custom_js %}
<script>
$(document).ready(function(){
    // Store conversation data
    const conversationData = {
        {% for student, messages in student_conversations.items %}
        {{ student.id }}: {
            student_id: {{ student.id }},
            student_name: "{{ student.first_name }} {{ student.last_name }}",
            student_email: "{{ student.email }}",
            messages: [
                {% for message in messages %}
                {
                    id: {{ message.id }},
                    content: "{{ message.content|escapejs }}",
                    message_type: "{{ message.message_type }}",
                            created_at: "{{ message.created_at|date:'c' }}",
                    is_read: {% if message.is_read %}true{% else %}false{% endif %}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    console.log('Conversation data loaded:', conversationData);

    // Function to format time display with Nepali timezone
    function formatTime(timeString) {
        const messageTime = new Date(timeString);
        const now = new Date();
        
        // Convert to Nepali time (UTC+5:45)
        const nepaliOffset = 5.75 * 60; // 5 hours 45 minutes in minutes
        const messageTimeNepali = new Date(messageTime.getTime() + (nepaliOffset * 60000));
        const nowNepali = new Date(now.getTime() + (nepaliOffset * 60000));
        
        const diffMs = nowNepali - messageTimeNepali;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) {
            return 'Just now';
        } else if (diffMins < 60) {
            return diffMins + 'm ago';
        } else if (diffHours < 24) {
            return diffHours + 'h ago';
        } else if (diffDays < 7) {
            return diffDays + 'd ago';
        } else {
            // Show full date and time in Nepali timezone
            const options = {
                timeZone: 'Asia/Kathmandu',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return messageTime.toLocaleDateString('en-US', options);
        }
    }

    // Function to update time display
    function updateTimeDisplay() {
        $('.message-time[data-time]').each(function() {
            const timeElement = $(this);
            const timeString = timeElement.data('time');
            timeElement.text(formatTime(timeString));
        });
    }

    // Update time display every minute
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 60000);

    // Handle conversation selection
    $('.conversation-card').click(function(){
        const studentId = $(this).data('student-id');
        const conversation = conversationData[studentId];
        
        if (!conversation) return;

        // Update active conversation
        $('.conversation-card').removeClass('active');
        $(this).addClass('active');

        // Show chat area
        $('#no-message-selected').hide();
        $('#chat-header').show();
        $('#reply-area').show();

        // Update chat header
        $('#chat-student-name').text(conversation.student_name);
        $('#chat-student-info').text('Student ID: ' + conversation.student_id + ' | ' + conversation.student_email);

        // Display messages
        displayMessages(conversation);

        // Set up reply form
        $('#reply_student_id').val(studentId);
    });

    // Display messages in chronological order
    function displayMessages(conversation) {
        const messagesContainer = $('#messages-container');
        messagesContainer.html('');

        if (!conversation.messages || conversation.messages.length === 0) {
            messagesContainer.html(`
                <div class="text-center py-5">
                    <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Messages Yet</h5>
                    <p class="text-muted">This conversation is empty.</p>
                </div>
            `);
            return;
        }

        // Sort messages by creation time (oldest first)
        const sortedMessages = conversation.messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        sortedMessages.forEach(message => {
            let messageHtml;
            
            if (message.message_type === 'student_to_admin') {
                // Student message (received)
                messageHtml = `
                    <div class="d-flex justify-content-start mb-3">
                        <div class="message-bubble message-received">
                            <div class="message-text">${message.content}</div>
                            <div class="message-time text-right" data-time="${message.created_at}">${formatTime(message.created_at)}</div>
                        </div>
                    </div>
                `;
            } else {
                // Admin message (sent)
                messageHtml = `
                    <div class="d-flex justify-content-end mb-3">
                        <div class="message-bubble message-sent">
                            <div class="message-text">${message.content}</div>
                            <div class="message-time text-left" data-time="${message.created_at}">${formatTime(message.created_at)}</div>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.append(messageHtml);
        });

        // Scroll to bottom
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
    }

    // Handle reply form submission
    $('#reply-form').submit(function(e){
        e.preventDefault();
        
        const studentId = $('#reply_student_id').val();
        const replyContent = $('textarea[name="reply"]').val().trim();
        
        if (!replyContent) {
            alert('Please enter a reply.');
            return;
        }

        // Disable form while sending
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');

        $.ajax({
            url: '{% url "student_feedback_message_reply" %}',
            type: 'POST',
            data: {
                'id': studentId,
                'reply': replyContent,
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response){
                if (response === "True") {
                    // Clear the textarea
                    $('textarea[name="reply"]').val('');
                    
                    // Add the new message to the conversation data
                    const conversation = conversationData[studentId];
                    if (conversation) {
                        const newMessage = {
                            id: Date.now(), // Temporary ID
                            content: replyContent,
                            message_type: 'admin_to_student',
                            created_at: new Date().toLocaleString(),
                            is_read: false
                        };
                        conversation.messages.push(newMessage);
                        
                        // Refresh the messages display
                        displayMessages(conversation);
                    }
                    
                    // Show success message
                    toastr.success('Reply sent successfully!');
                } else {
                    toastr.error('Failed to send reply. Please try again.');
                }
            },
            error: function(){
                toastr.error('An error occurred. Please try again.');
            },
            complete: function(){
                // Re-enable form
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Auto-resize textarea
    $('textarea[name="reply"]').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Search functionality
    $('#search-student').on('keyup', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.conversation-card').each(function() {
            const studentName = $(this).find('h6').text().toLowerCase();
            if (studentName.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});
</script>
{% endblock custom_js %}