{% extends 'student_template/base_template.html' %}

{% block page_title %}
    Messages & Feedback
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-comments mr-2"></i>Messages & Feedback
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#newMessageModal">
                                <i class="fas fa-plus mr-1"></i>New Message
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row no-gutters">
                            <!-- Conversations List -->
                            <div class="col-md-4 border-right">
                                <!-- Search Bar -->
                                <div class="p-3 border-bottom">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="search-people" placeholder="Search people to message...">
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="conversations-list" style="height: 600px; overflow-y: auto;">
                                    <!-- Single Admin Conversation -->
                                    <div class="conversation-item p-3 border-bottom conversation-card active" data-conversation-type="admin" style="cursor: pointer;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-warning text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-user-shield"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 text-warning">Admin</h6>
                                                <p class="mb-1 text-muted small">
                                                    {% if feedback_data %}
                                                        {% with latest_feedback=feedback_data|first %}
                                                            {% if latest_feedback.feedback_reply %}
                                                                <i class="fas fa-reply text-success mr-1"></i>Last message: {{ latest_feedback.feedback_reply|truncatechars:30 }}
                                                            {% else %}
                                                                <i class="fas fa-clock text-warning mr-1"></i>Waiting for reply
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <i class="fas fa-comment mr-1"></i>Start conversation
                                                    {% endif %}
                                                </p>
                                                <small class="text-muted">
                                                    {% if feedback_data %}
                                                        {% with latest_feedback=feedback_data|first %}
                                                            {{ latest_feedback.created_at|date:"M d, Y H:i" }}
                                                        {% endwith %}
                                                    {% else %}
                                                        Click to start conversation
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>

                            <!-- Chat Area -->
                            <div class="col-md-8">
                                <div id="chat-area" style="height: 600px; display: flex; flex-direction: column;">
                                    <!-- Chat Header -->
                                    <div class="chat-header p-3 border-bottom bg-light" id="chat-header" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-warning text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user-shield"></i>
                        </div>
                                            <div>
                                                <h6 class="mb-0" id="chat-user-name">Admin</h6>
                                                <small class="text-muted" id="chat-user-info">Send feedback and messages</small>
                    </div>
                </div>
            </div>

                                    <!-- Messages Area -->
                                    <div class="messages-container flex-grow-1 p-3" id="messages-container" style="overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="text-center py-5" id="no-message-selected">
                                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">Start a Conversation</h5>
                                            <p class="text-muted">Click "New Message" to send feedback to admin or select an existing conversation.</p>
                                        </div>
                        </div>
                                    
                                    <!-- Message Input Area -->
                                    <div class="message-input p-3 border-top bg-white" id="message-input" style="display: none;">
                                        <form id="message-form">
                                            {% csrf_token %}
                                            <div class="input-group">
                                                <textarea class="form-control" id="message_text" name="message" rows="2" placeholder="Type your message..." required></textarea>
                                                <div class="input-group-append">
                                                    <button class="btn btn-success" type="submit" id="send-message-btn">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
      </section>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Message</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="new-message-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>Send feedback to Admin</label>
                        <textarea class="form-control" name="feedback_message" rows="4" placeholder="Type your feedback message..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="send-new-message">Send Message</button>
            </div>
        </div>
    </div>
</div>

<style>
.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.active {
    background-color: #d4edda;
    border-left: 4px solid #28a745;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.message-sent {
    background-color: #28a745;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.message-received {
    background-color: #e9ecef;
    color: #333;
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
}

.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

  {% endblock main_content %}

{% block custom_js %}
<script>
$(document).ready(function(){
            // Store feedback data for easy access
            const feedbackData = {
                {% for feedback in feedback_data %}
                {{ feedback.id }}: {
                    id: {{ feedback.id }},
                    message: "{{ feedback.feedback|escapejs }}",
                    reply: "{{ feedback.feedback_reply|escapejs }}",
                    created_at: "{{ feedback.created_at|date:'M d, Y H:i' }}",
                    has_reply: {% if feedback.feedback_reply %}true{% else %}false{% endif %}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            };
            
            console.log('Feedback data loaded:', feedbackData);
            console.log('Number of feedback entries:', Object.keys(feedbackData).length);

    // Handle conversation selection
    $('.conversation-card').click(function(){
        const conversationType = $(this).data('conversation-type');
        
        // Update active conversation
        $('.conversation-card').removeClass('active');
        $(this).addClass('active');

        // Show chat area
        $('#no-message-selected').hide();
        $('#chat-header').show();
        $('#message-input').show();

        if (conversationType === 'admin') {
            // Unified conversation with admin - show all messages
            $('#chat-user-name').text('Admin');
            $('#chat-user-info').text('All messages with admin');
            displayAllMessages();
        }
    });

    // Display all messages in chronological order
    function displayAllMessages() {
        const messagesContainer = $('#messages-container');
        messagesContainer.html('');

        console.log('Displaying all messages. Feedback data:', feedbackData);
        console.log('Number of messages:', Object.keys(feedbackData).length);

        // Check if feedbackData is empty or undefined
        if (!feedbackData || Object.keys(feedbackData).length === 0) {
            console.log('No feedback data found, showing empty state');
            messagesContainer.html(`
                <div class="text-center py-5">
                    <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Messages Yet</h5>
                    <p class="text-muted">Type your message below to start the conversation.</p>
                </div>
            `);
            return;
        }

        // Convert feedback data to array and sort by creation time (oldest first)
        const allMessages = Object.values(feedbackData).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        console.log('Sorted messages:', allMessages);
        console.log('Total messages to display:', allMessages.length);

        let messageCount = 0;
        allMessages.forEach((feedback, index) => {
            console.log(`Processing message ${index + 1}:`, feedback);
            messageCount++;
            
            // Student message (sent)
            const studentMessage = `
                <div class="d-flex justify-content-end mb-3">
                    <div class="message-bubble message-sent">
                        <div class="message-text">${feedback.message}</div>
                        <div class="message-time text-left">${feedback.created_at}</div>
                    </div>
                </div>
            `;
            messagesContainer.append(studentMessage);

            // Admin reply (received) - if exists
            if (feedback.has_reply) {
                const adminMessage = `
                    <div class="d-flex justify-content-start mb-3">
                        <div class="message-bubble message-received">
                            <div class="message-text">${feedback.reply}</div>
                            <div class="message-time text-right">Replied</div>
                        </div>
                    </div>
                `;
                messagesContainer.append(adminMessage);
            }
        });
        
        console.log(`Total messages displayed: ${messageCount}`);

        // Scroll to bottom
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
    }

    // Display messages in chat format (legacy function)
    function displayMessages(feedback) {
        const messagesContainer = $('#messages-container');
        messagesContainer.html('');

        // Student message (sent)
        const studentMessage = `
            <div class="d-flex justify-content-end mb-3">
                <div class="message-bubble message-sent">
                    <div class="message-text">${feedback.message}</div>
                    <div class="message-time text-left">${feedback.created_at}</div>
                </div>
            </div>
        `;
        messagesContainer.append(studentMessage);

        // Admin reply (received) - if exists
        if (feedback.has_reply) {
            const adminMessage = `
                <div class="d-flex justify-content-start mb-3">
                    <div class="message-bubble message-received">
                        <div class="message-text">${feedback.reply}</div>
                        <div class="message-time text-right">Replied</div>
                    </div>
                </div>
            `;
            messagesContainer.append(adminMessage);
        }

        // Scroll to bottom
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
    }

    // Display new conversation interface
    function displayNewConversation() {
        const messagesContainer = $('#messages-container');
        messagesContainer.html(`
            <div class="text-center py-5">
                <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">New Conversation</h5>
                <p class="text-muted">Type your message below to send feedback to admin.</p>
            </div>
        `);
    }

    // Handle new message form submission
    $('#send-new-message').click(function(){
        const message = $('textarea[name="feedback_message"]').val().trim();
        
        if (!message) {
            alert('Please enter a message.');
            return;
        }

        // Disable button while sending
        $(this).prop('disabled', true).text('Sending...');

        $.ajax({
            url: '{% url "student_feedback_save" %}',
            type: 'POST',
            data: {
                feedback_message: message,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                // Close modal
                $('#newMessageModal').modal('hide');
                
                // Clear the form
                $('textarea[name="feedback_message"]').val('');
                
                // Show success message
                showNotification('Message sent successfully!', 'success');
                
                // Reload page to show new message in conversation
                setTimeout(function() {
                    location.reload();
                }, 1000);
            },
            error: function() {
                showNotification('Error sending message. Please try again.', 'error');
            },
            complete: function() {
                $('#send-new-message').prop('disabled', false).text('Send Message');
            }
        });
    });

    // Handle message form submission (for replies)
    $('#message-form').on('submit', function(e){
        e.preventDefault();
        
        const message = $('#message_text').val().trim();
        
        if (!message) {
            alert('Please enter a message.');
            return;
        }

        // For now, just show a message that this would send a new feedback
        showNotification('Use "New Message" to send feedback to admin.', 'info');
        $('#message_text').val('');
    });

    // Notification function
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        const notification = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        $('body').append(notification);
        
        // Auto remove after 3 seconds
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 3000);
    }

    // Auto-resize textarea
    $('#message_text, textarea[name="feedback_message"]').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Search functionality
    $('#search-people').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.conversation-item').each(function() {
            const text = $(this).text().toLowerCase();
            if (text.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // Auto-load the conversation when page loads
    if ($('.conversation-card.active').length > 0) {
        $('.conversation-card.active').click();
    }
});
</script>
{% endblock custom_js %}