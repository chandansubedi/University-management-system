{% extends 'hod_template/base_template.html' %}

{% block page_title %}
    Student Messages
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-comments mr-2"></i>Student Messages
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-primary">{{ student_conversations|length }} Conversations</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row no-gutters">
                            <!-- Conversations List -->
                            <div class="col-md-4 border-right">
                                <!-- Search Bar -->
                                <div class="p-3 border-bottom">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="search-student" placeholder="Search students...">
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="conversations-list" style="height: 600px; overflow-y: auto;">
                                    {% for student, messages in student_conversations.items %}
                                    <div class="conversation-item p-3 border-bottom conversation-card" data-student-id="{{ student.id }}" style="cursor: pointer;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 text-success">
                                                    <a href="{% url 'student_detail' student.id %}" class="text-decoration-none">
                                                        {{ student.first_name }} {{ student.last_name }}
                                                    </a>
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    {% for message in messages reversed %}
                                                        {% if forloop.first %}
                                                            {% if message.feedback_reply %}
                                                                <i class="fas fa-reply text-success mr-1"></i>{{ message.feedback_reply|truncatechars:30 }}
                                                            {% else %}
                                                                <i class="fas fa-comment text-success mr-1"></i>{{ message.feedback|truncatechars:30 }}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </p>
                                                <small class="text-muted">
                                                    {% for message in messages reversed %}
                                                        {% if forloop.first %}
                                                            {{ message.created_at|date:"M d, Y H:i" }}
                                                        {% endif %}
                                                    {% endfor %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No Messages</h5>
                                        <p class="text-muted">No students have sent messages yet.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Chat Area -->
                            <div class="col-md-8">
                                <div id="chat-area" style="height: 600px; display: flex; flex-direction: column;">
                                    <!-- Chat Header -->
                                    <div class="chat-header p-3 border-bottom bg-light" id="chat-header" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0" id="chat-student-name"></h6>
                                                <small class="text-muted" id="chat-student-info"></small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Messages Area -->
                                    <div class="messages-container flex-grow-1 p-3" id="messages-container" style="overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="text-center py-5" id="no-message-selected">
                                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">Select a Conversation</h5>
                                            <p class="text-muted">Choose a student from the list to view messages.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Reply Area -->
                                    <div class="reply-area p-3 border-top bg-white" id="reply-area" style="display: none;">
                                        <form id="reply-form">
                                            {% csrf_token %}
                                            <input type="hidden" id="reply_student_id" name="student_id">
                                            <div class="input-group">
                                                <textarea class="form-control" id="reply_message" name="reply" rows="2" placeholder="Type your reply..." required></textarea>
                                                <div class="input-group-append">
                                                    <button class="btn btn-success" type="submit" id="send-reply-btn">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.active {
    background-color: #e8f5e8;
    border-left: 4px solid #28a745;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.message-sent {
    background-color: #28a745;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.message-received {
    background-color: #e9ecef;
    color: #333;
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
}

.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

{% endblock main_content %}

{% block custom_js %}
<script>
$(document).ready(function(){
    // Store conversation data
    const conversationData = {
        {% for student, messages in student_conversations.items %}
        {{ student.id }}: {
            student_id: {{ student.id }},
            student_name: "{{ student.first_name }} {{ student.last_name }}",
            student_email: "{{ student.email }}",
            messages: [
                {% for message in messages %}
                {
                    id: {{ message.id }},
                    message: "{{ message.feedback|escapejs }}",
                    reply: "{{ message.feedback_reply|escapejs }}",
                    created_at: "{{ message.created_at|date:'M d, Y H:i' }}",
                    has_reply: {% if message.feedback_reply %}true{% else %}false{% endif %}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    console.log('Student conversation data loaded:', conversationData);

    // Handle conversation selection
    $('.conversation-card').click(function(){
        const studentId = $(this).data('student-id');
        const conversation = conversationData[studentId];
        
        if (!conversation) return;

        // Update active conversation
        $('.conversation-card').removeClass('active');
        $(this).addClass('active');

        // Show chat area
        $('#no-message-selected').hide();
        $('#chat-header').show();
        $('#reply-area').show();

        // Update chat header
        $('#chat-student-name').text(conversation.student_name);
        $('#chat-student-info').text('Student ID: ' + conversation.student_id + ' | ' + conversation.student_email);

        // Display messages
        displayMessages(conversation);

        // Set up reply form
        $('#reply_student_id').val(studentId);
    });

    // Display messages in chronological order
    function displayMessages(conversation) {
        const messagesContainer = $('#messages-container');
        messagesContainer.html('');

        if (!conversation.messages || conversation.messages.length === 0) {
            messagesContainer.html(`
                <div class="text-center py-5">
                    <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Messages Yet</h5>
                    <p class="text-muted">This student hasn't sent any messages yet.</p>
                </div>
            `);
            return;
        }

        // Sort messages by creation time (oldest first)
        const sortedMessages = conversation.messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        
        console.log('Displaying messages for', conversation.student_name, ':', sortedMessages);

        sortedMessages.forEach(message => {
            // Student message (received)
            const studentMessage = `
                <div class="d-flex justify-content-start mb-3">
                    <div class="message-bubble message-received">
                        <div class="message-text">${message.message}</div>
                        <div class="message-time text-right">${message.created_at}</div>
                    </div>
                </div>
            `;
            messagesContainer.append(studentMessage);

            // Admin reply (sent) - if exists
            if (message.has_reply) {
                const adminMessage = `
                    <div class="d-flex justify-content-end mb-3">
                        <div class="message-bubble message-sent">
                            <div class="message-text">${message.reply}</div>
                            <div class="message-time text-left">Replied</div>
                        </div>
                    </div>
                `;
                messagesContainer.append(adminMessage);
            }
        });

        // Scroll to bottom
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
    }

    // Handle reply form submission
    $('#reply-form').on('submit', function(e){
        e.preventDefault();
        
        const studentId = $('#reply_student_id').val();
        const reply = $('#reply_message').val().trim();
        
        if (!reply) {
            alert('Please enter a reply message.');
            return;
        }

        // Disable form while sending
        $('#send-reply-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        $.ajax({
            url: '{% url "student_feedback_message_reply" %}',
            type: 'POST',
            data: {
                id: studentId,
                reply: reply,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response === "True") {
                    // Add the reply to the chat immediately
                    const adminMessage = `
                        <div class="d-flex justify-content-end mb-3">
                            <div class="message-bubble message-sent">
                                <div class="message-text">${reply}</div>
                                <div class="message-time text-left">Just now</div>
                            </div>
                        </div>
                    `;
                    $('#messages-container').append(adminMessage);
                    
                    // Clear form
                    $('#reply_message').val('');
                    
                    // Scroll to bottom
                    $('#messages-container').scrollTop($('#messages-container')[0].scrollHeight);
                    
                    // Show success message
                    showNotification('Reply sent successfully!', 'success');
                } else {
                    showNotification('Failed to send reply. Please try again.', 'error');
                }
            },
            error: function() {
                showNotification('Error sending reply. Please try again.', 'error');
            },
            complete: function() {
                $('#send-reply-btn').prop('disabled', false).html('<i class="fas fa-paper-plane"></i>');
            }
        });
    });

    // Notification function
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const notification = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        $('body').append(notification);
        
        // Auto remove after 3 seconds
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 3000);
    }

    // Auto-resize textarea
    $('#reply_message').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Search functionality
    $('#search-student').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.conversation-item').each(function() {
            const text = $(this).text().toLowerCase();
            if (text.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});
</script>
{% endblock custom_js %}