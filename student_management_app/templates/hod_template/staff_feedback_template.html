{% extends 'hod_template/base_template.html' %}

{% block page_title %}
    Staff Feedback Messages
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-comments mr-2"></i>Staff Feedback Messages
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-primary">{{ feedbacks|length }} Conversations</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row no-gutters">
                            <!-- Conversations List -->
                            <div class="col-md-4 border-right">
                                <div class="conversations-list" style="height: 600px; overflow-y: auto;">
                                    {% for feedback in feedbacks %}
                                    <div class="conversation-item p-3 border-bottom conversation-card" data-feedback-id="{{ feedback.id }}" style="cursor: pointer;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 text-primary">
                                                    <a href="{% url 'staff_detail' feedback.staff_id.admin.id %}" class="text-decoration-none">
                                                        {{ feedback.staff_id.admin.first_name }} {{ feedback.staff_id.admin.last_name }}
                                                    </a>
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    {% if feedback.feedback_reply %}
                                                        <i class="fas fa-reply text-success mr-1"></i>Replied
                                                    {% else %}
                                                        <i class="fas fa-clock text-warning mr-1"></i>Pending Reply
                                                    {% endif %}
                                                </p>
                                                <small class="text-muted">{{ feedback.created_at|date:"M d, Y H:i" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No Feedback Messages</h5>
                                        <p class="text-muted">No staff members have sent feedback yet.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Chat Area -->
                            <div class="col-md-8">
                                <div id="chat-area" style="height: 600px; display: flex; flex-direction: column;">
                                    <!-- Chat Header -->
                                    <div class="chat-header p-3 border-bottom bg-light" id="chat-header" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0" id="chat-user-name"></h6>
                                                <small class="text-muted" id="chat-user-info"></small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Messages Area -->
                                    <div class="messages-container flex-grow-1 p-3" id="messages-container" style="overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="text-center py-5" id="no-message-selected">
                                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">Select a Conversation</h5>
                                            <p class="text-muted">Choose a staff member from the list to view their feedback messages.</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Reply Area -->
                                    <div class="reply-area p-3 border-top bg-white" id="reply-area" style="display: none;">
                                        <form id="reply-form">
                                            {% csrf_token %}
                                            <input type="hidden" id="reply_feedback_id" name="feedback_id">
                                            <div class="input-group">
                                                <textarea class="form-control" id="reply_message" name="reply" rows="2" placeholder="Type your reply..." required></textarea>
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary" type="submit" id="send-reply-btn">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.active {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.message-sent {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.message-received {
    background-color: #e9ecef;
    color: #333;
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
}

.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

      {% comment %} Modal to Reply Feedback {% endcomment %}
      <!-- Modal -->
        <div class="modal fade" id="replyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Reply Feedback</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Reply to: <b><span id="reply_name"></span></b></p>
                <input type="hidden" id="reply_id" name="reply_id" />
                <textarea class="form-control" rows="5" id="reply_message"></textarea>
            </div>
            <div class="modal-footer">
                {% comment %} <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> {% endcomment %}
                <button type="button" class="btn btn-primary btn-block" id="reply_button">Reply</button>
            </div>
            </div>
        </div>
        </div>

  {% endblock main_content %}

  {% comment %} Custom JS to Identify the Reply and Post Reply {% endcomment %}

  {% block custom_js %}
    <script>
        $(document).ready(function(){
            // Store feedback data for easy access
            const feedbackData = {
                {% for feedback in feedbacks %}
                {{ feedback.id }}: {
                    id: {{ feedback.id }},
                    staff_name: "{{ feedback.staff_id.admin.first_name }} {{ feedback.staff_id.admin.last_name }}",
                    staff_id: {{ feedback.staff_id.admin.id }},
                    message: "{{ feedback.feedback|escapejs }}",
                    reply: "{{ feedback.feedback_reply|escapejs }}",
                    created_at: "{{ feedback.created_at|date:'M d, Y H:i' }}",
                    has_reply: {% if feedback.feedback_reply %}true{% else %}false{% endif %}
                },
                {% endfor %}
            };

            // Handle conversation selection
            $('.conversation-card').click(function(){
                const feedbackId = $(this).data('feedback-id');
                const feedback = feedbackData[feedbackId];
                
                if (!feedback) return;

                // Update active conversation
                $('.conversation-card').removeClass('active');
                $(this).addClass('active');

                // Show chat area
                $('#no-message-selected').hide();
                $('#chat-header').show();
                $('#reply-area').show();

                // Update chat header
                $('#chat-user-name').text(feedback.staff_name);
                $('#chat-user-info').text('Staff ID: ' + feedback.staff_id);

                // Display messages
                displayMessages(feedback);

                // Set up reply form
                $('#reply_feedback_id').val(feedbackId);
            });

            // Display messages in chat format
            function displayMessages(feedback) {
                const messagesContainer = $('#messages-container');
                messagesContainer.html('');

                // Staff message (received)
                const staffMessage = `
                    <div class="d-flex justify-content-start mb-3">
                        <div class="message-bubble message-received">
                            <div class="message-text">${feedback.message}</div>
                            <div class="message-time text-right">${feedback.created_at}</div>
                        </div>
                    </div>
                `;
                messagesContainer.append(staffMessage);

                // Admin reply (sent) - if exists
                if (feedback.has_reply) {
                    const adminMessage = `
                        <div class="d-flex justify-content-end mb-3">
                            <div class="message-bubble message-sent">
                                <div class="message-text">${feedback.reply}</div>
                                <div class="message-time text-left">Replied</div>
                            </div>
                        </div>
                    `;
                    messagesContainer.append(adminMessage);
                }

                // Scroll to bottom
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
            }

            // Handle reply form submission
            $('#reply-form').on('submit', function(e){
                e.preventDefault();
                
                const feedbackId = $('#reply_feedback_id').val();
                const reply = $('#reply_message').val().trim();
                
                if (!reply) {
                    alert('Please enter a reply message.');
                    return;
                }

                // Disable form while sending
                $('#send-reply-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                $.ajax({
                    url: '{% url "staff_feedback_message_reply" %}',
                    type: 'POST',
                    data: {
                        id: feedbackId,
                        reply: reply,
                        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response === "True") {
                            // Add the reply to the chat
                            const adminMessage = `
                                <div class="d-flex justify-content-end mb-3">
                                    <div class="message-bubble message-sent">
                                        <div class="message-text">${reply}</div>
                                        <div class="message-time text-left">Just now</div>
                                    </div>
                                </div>
                            `;
                            $('#messages-container').append(adminMessage);
                            
                            // Clear form
                            $('#reply_message').val('');
                            
                            // Update conversation status
                            const activeCard = $('.conversation-card.active');
                            activeCard.find('.text-muted.small').html('<i class="fas fa-reply text-success mr-1"></i>Replied');
                            
                            // Scroll to bottom
                            $('#messages-container').scrollTop($('#messages-container')[0].scrollHeight);
                            
                            // Show success message
                            showNotification('Reply sent successfully!', 'success');
                        } else {
                            showNotification('Failed to send reply. Please try again.', 'error');
                        }
                    },
                    error: function() {
                        showNotification('Error sending reply. Please try again.', 'error');
                    },
                    complete: function() {
                        $('#send-reply-btn').prop('disabled', false).html('<i class="fas fa-paper-plane"></i>');
                    }
                });
            });

            // Notification function
            function showNotification(message, type) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                const notification = `
                    <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                `;
                $('body').append(notification);
                
                // Auto remove after 3 seconds
                setTimeout(function() {
                    $('.alert').fadeOut();
                }, 3000);
            }

            // Auto-resize textarea
            $('#reply_message').on('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });
    </script>
  {% endblock custom_js %}